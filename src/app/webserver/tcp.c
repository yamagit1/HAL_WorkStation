#include "tcp.h"
#include "console_serial_trace.h"

//--------------------------------------------------
//-----------------------------------------------
extern __uint8 net_buf[ENC28J60_MAXFRAME];
extern __uint8 macaddr[6];
extern __uint8 ipaddr[4];
FATFS SDFatFs;//��������� �� ������
extern char USERPath[4]; /* logical drive path */
FIL MyFile;
FRESULT result; //��������� ����������
uint32_t bytesread;
tcp_prop_ptr tcpprop;
volatile __uint16 tcp_mss = 458;
volatile __uint16 tcp_size_wnd = 8192;
volatile __uint8 tcp_stat = TCP_DISCONNECTED;
//--------------------------------------------------
const char http_header[] = {"HTTP/1.0 200 OK\r\nServer: nginx\r\nContent-Type: text/html\r\nConnection: close\r\n\r\n"};
const char jpg_header[] = {"HTTP/1.0 200 OK\r\nServer: nginx\r\nContent-Type: image/jpeg\r\nConnection: close\r\n\r\n"};
const char error_header[] = {"HTTP/1.0 404 File not found\r\nServer: nginx\r\nContent-Type: text/html\r\nConnection: close\r\n\r\n"};
const __uint8 index_htm[] = {
		0x3c,0x68,0x74,0x6d,0x6c,0x3e,0x3c,0x62,0x6f,0x64,0x79,0x3e,0x3c,0x68,0x31,0x20,
		0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x74,0x65,0x78,0x74,0x2d,0x61,0x6c,0x69,0x67,
		0x6e,0x3a,0x20,0x63,0x65,0x6e,0x74,0x65,0x72,0x3b,0x22,0x3e,0x53,0x54,0x4d,0x33,
		0x32,0x46,0x31,0x30,0x33,0x78,0x38,0x3c,0x62,0x72,0x3e,0x3c,0x62,0x72,0x3e,0x57,
		0x45,0x42,0x20,0x53,0x65,0x72,0x76,0x65,0x72,0x3c,0x2f,0x68,0x31,0x3e,0x0a,0x3c,
		0x70,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x68,0x32,0x3e,0x46,0x65,0x61,0x74,0x75,
		0x72,0x65,0x73,0x3c,0x2f,0x68,0x32,0x3e,0x0a,0x3c,0x70,0x3e,0x41,0x52,0x4d,0xae,
		0x20,0x33,0x32,0x2d,0x62,0x69,0x74,0x20,0x43,0x6f,0x72,0x74,0x65,0x78,0xae,0x2d,
		0x4d,0x33,0x20,0x43,0x50,0x55,0x20,0x43,0x6f,0x72,0x65,0x3c,0x2f,0x70,0x3e,0x0a,
		0x3c,0x70,0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x37,0x32,0x20,
		0x4d,0x48,0x7a,0x20,0x6d,0x61,0x78,0x69,0x6d,0x75,0x6d,0x20,0x66,0x72,0x65,0x71,
		0x75,0x65,0x6e,0x63,0x79,0x2c,0x20,0x31,0x2e,0x32,0x35,0x20,0x44,0x4d,0x49,0x50,
		0x53,0x2f,0x4d,0x48,0x7a,0x20,0x28,0x44,0x68,0x72,0x79,0x73,0x74,0x6f,0x6e,0x65,
		0x20,0x32,0x2e,0x31,0x29,0x20,0x70,0x65,0x72,0x66,0x6f,0x72,0x6d,0x61,0x6e,0x63,
		0x65,0x20,0x61,0x74,0x20,0x30,0x20,0x77,0x61,0x69,0x74,0x20,0x73,0x74,0x61,0x74,
		0x65,0x20,0x6d,0x65,0x6d,0x6f,0x72,0x79,0x20,0x61,0x63,0x63,0x65,0x73,0x73,0x3c,
		0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x53,0x69,0x6e,0x67,0x6c,0x65,
		0x2d,0x63,0x79,0x63,0x6c,0x65,0x20,0x6d,0x75,0x6c,0x74,0x69,0x70,0x6c,0x69,0x63,
		0x61,0x74,0x69,0x6f,0x6e,0x20,0x61,0x6e,0x64,0x20,0x68,0x61,0x72,0x64,0x77,0x61,
		0x72,0x65,0x20,0x64,0x69,0x76,0x69,0x73,0x69,0x6f,0x6e,0x3c,0x2f,0x6c,0x69,0x3e,
		0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x4d,0x65,
		0x6d,0x6f,0x72,0x69,0x65,0x73,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x3c,0x75,
		0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x36,0x34,0x20,0x6f,0x72,0x20,0x31,0x32,
		0x38,0x20,0x4b,0x62,0x79,0x74,0x65,0x73,0x20,0x6f,0x66,0x20,0x46,0x6c,0x61,0x73,
		0x68,0x20,0x6d,0x65,0x6d,0x6f,0x72,0x79,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,
		0x6c,0x69,0x3e,0x32,0x30,0x20,0x4b,0x62,0x79,0x74,0x65,0x73,0x20,0x6f,0x66,0x20,
		0x53,0x52,0x41,0x4d,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,
		0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x43,0x6c,0x6f,0x63,0x6b,0x2c,0x20,0x72,0x65,
		0x73,0x65,0x74,0x20,0x61,0x6e,0x64,0x20,0x73,0x75,0x70,0x70,0x6c,0x79,0x20,0x6d,
		0x61,0x6e,0x61,0x67,0x65,0x6d,0x65,0x6e,0x74,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,
		0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x32,0x2e,0x30,0x20,0x74,
		0x6f,0x20,0x33,0x2e,0x36,0x20,0x56,0x20,0x61,0x70,0x70,0x6c,0x69,0x63,0x61,0x74,
		0x69,0x6f,0x6e,0x20,0x73,0x75,0x70,0x70,0x6c,0x79,0x20,0x61,0x6e,0x64,0x20,0x49,
		0x2f,0x4f,0x73,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x50,0x4f,
		0x52,0x2c,0x20,0x50,0x44,0x52,0x2c,0x20,0x61,0x6e,0x64,0x20,0x70,0x72,0x6f,0x67,
		0x72,0x61,0x6d,0x6d,0x61,0x62,0x6c,0x65,0x20,0x76,0x6f,0x6c,0x74,0x61,0x67,0x65,
		0x20,0x64,0x65,0x74,0x65,0x63,0x74,0x6f,0x72,0x20,0x28,0x50,0x56,0x44,0x29,0x3c,
		0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x34,0x2d,0x74,0x6f,0x2d,0x31,
		0x36,0x20,0x4d,0x48,0x7a,0x20,0x63,0x72,0x79,0x73,0x74,0x61,0x6c,0x20,0x6f,0x73,
		0x63,0x69,0x6c,0x6c,0x61,0x74,0x6f,0x72,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,
		0x6c,0x69,0x3e,0x49,0x6e,0x74,0x65,0x72,0x6e,0x61,0x6c,0x20,0x38,0x20,0x4d,0x48,
		0x7a,0x20,0x66,0x61,0x63,0x74,0x6f,0x72,0x79,0x2d,0x74,0x72,0x69,0x6d,0x6d,0x65,
		0x64,0x20,0x52,0x43,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x49,
		0x6e,0x74,0x65,0x72,0x6e,0x61,0x6c,0x20,0x34,0x30,0x20,0x6b,0x48,0x7a,0x20,0x52,
		0x43,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x50,0x4c,0x4c,0x20,
		0x66,0x6f,0x72,0x20,0x43,0x50,0x55,0x20,0x63,0x6c,0x6f,0x63,0x6b,0x3c,0x2f,0x6c,
		0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x33,0x32,0x20,0x6b,0x48,0x7a,0x20,0x6f,
		0x73,0x63,0x69,0x6c,0x6c,0x61,0x74,0x6f,0x72,0x20,0x66,0x6f,0x72,0x20,0x52,0x54,
		0x43,0x20,0x77,0x69,0x74,0x68,0x20,0x63,0x61,0x6c,0x69,0x62,0x72,0x61,0x74,0x69,
		0x6f,0x6e,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,
		0x3e,0x0a,0x3c,0x70,0x3e,0x4c,0x6f,0x77,0x2d,0x70,0x6f,0x77,0x65,0x72,0x3c,0x2f,
		0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,
		0x53,0x6c,0x65,0x65,0x70,0x2c,0x20,0x53,0x74,0x6f,0x70,0x20,0x61,0x6e,0x64,0x20,
		0x53,0x74,0x61,0x6e,0x64,0x62,0x79,0x20,0x6d,0x6f,0x64,0x65,0x73,0x3c,0x2f,0x6c,
		0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x56,0x42,0x41,0x54,0x20,0x73,0x75,0x70,
		0x70,0x6c,0x79,0x20,0x66,0x6f,0x72,0x20,0x52,0x54,0x43,0x20,0x61,0x6e,0x64,0x20,
		0x62,0x61,0x63,0x6b,0x75,0x70,0x20,0x72,0x65,0x67,0x69,0x73,0x74,0x65,0x72,0x73,
		0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,
		0x3c,0x70,0x3e,0x32,0x20,0x78,0x20,0x31,0x32,0x2d,0x62,0x69,0x74,0x2c,0x20,0x31,
		0x20,0x3f,0x73,0x20,0x41,0x2f,0x44,0x20,0x63,0x6f,0x6e,0x76,0x65,0x72,0x74,0x65,
		0x72,0x73,0x20,0x28,0x75,0x70,0x20,0x74,0x6f,0x20,0x31,0x36,0x20,0x63,0x68,0x61,
		0x6e,0x6e,0x65,0x6c,0x73,0x29,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x3c,0x75,
		0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x43,0x6f,0x6e,0x76,0x65,0x72,0x73,0x69,
		0x6f,0x6e,0x20,0x72,0x61,0x6e,0x67,0x65,0x3a,0x20,0x30,0x20,0x74,0x6f,0x20,0x33,
		0x2e,0x36,0x20,0x56,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x44,
		0x75,0x61,0x6c,0x2d,0x73,0x61,0x6d,0x70,0x6c,0x65,0x20,0x61,0x6e,0x64,0x20,0x68,
		0x6f,0x6c,0x64,0x20,0x63,0x61,0x70,0x61,0x62,0x69,0x6c,0x69,0x74,0x79,0x3c,0x2f,
		0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x54,0x65,0x6d,0x70,0x65,0x72,0x61,
		0x74,0x75,0x72,0x65,0x20,0x73,0x65,0x6e,0x73,0x6f,0x72,0x3c,0x2f,0x6c,0x69,0x3e,
		0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x44,0x4d,
		0x41,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,
		0x6c,0x69,0x3e,0x37,0x2d,0x63,0x68,0x61,0x6e,0x6e,0x65,0x6c,0x20,0x44,0x4d,0x41,
		0x20,0x63,0x6f,0x6e,0x74,0x72,0x6f,0x6c,0x6c,0x65,0x72,0x3c,0x2f,0x6c,0x69,0x3e,
		0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x50,0x65,0x72,0x69,0x70,0x68,0x65,0x72,0x61,0x6c,
		0x73,0x20,0x73,0x75,0x70,0x70,0x6f,0x72,0x74,0x65,0x64,0x3a,0x20,0x74,0x69,0x6d,
		0x65,0x72,0x73,0x2c,0x20,0x41,0x44,0x43,0x2c,0x20,0x53,0x50,0x49,0x73,0x2c,0x20,
		0x49,0x32,0x43,0x73,0x20,0x61,0x6e,0x64,0x20,0x55,0x53,0x41,0x52,0x54,0x73,0x3c,
		0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,
		0x70,0x3e,0x55,0x70,0x20,0x74,0x6f,0x20,0x38,0x30,0x20,0x66,0x61,0x73,0x74,0x20,
		0x49,0x2f,0x4f,0x20,0x70,0x6f,0x72,0x74,0x73,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,
		0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x32,0x36,0x2f,0x33,0x37,
		0x2f,0x35,0x31,0x2f,0x38,0x30,0x20,0x49,0x2f,0x4f,0x73,0x2c,0x20,0x61,0x6c,0x6c,
		0x20,0x6d,0x61,0x70,0x70,0x61,0x62,0x6c,0x65,0x20,0x6f,0x6e,0x20,0x31,0x36,0x20,
		0x65,0x78,0x74,0x65,0x72,0x6e,0x61,0x6c,0x20,0x69,0x6e,0x74,0x65,0x72,0x72,0x75,
		0x70,0x74,0x20,0x76,0x65,0x63,0x74,0x6f,0x72,0x73,0x20,0x61,0x6e,0x64,0x20,0x61,
		0x6c,0x6d,0x6f,0x73,0x74,0x20,0x61,0x6c,0x6c,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,
		0x3c,0x6c,0x69,0x3e,0x35,0x20,0x56,0x2d,0x74,0x6f,0x6c,0x65,0x72,0x61,0x6e,0x74,
		0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,0x2f,0x70,0x3e,0x0a,
		0x3c,0x70,0x3e,0x37,0x20,0x74,0x69,0x6d,0x65,0x72,0x73,0x3c,0x2f,0x70,0x3e,0x0a,
		0x3c,0x70,0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x62,0x69,0x74,
		0x20,0x74,0x69,0x6d,0x65,0x72,0x73,0x2c,0x20,0x65,0x61,0x63,0x68,0x20,0x77,0x69,
		0x74,0x68,0x20,0x75,0x70,0x20,0x74,0x6f,0x20,0x34,0x20,0x49,0x43,0x2f,0x4f,0x43,
		0x2f,0x50,0x57,0x4d,0x20,0x6f,0x72,0x20,0x70,0x75,0x6c,0x73,0x65,0x20,0x63,0x6f,
		0x75,0x6e,0x74,0x65,0x72,0x20,0x61,0x6e,0x64,0x20,0x71,0x75,0x61,0x64,0x72,0x61,
		0x74,0x75,0x72,0x65,0x20,0x28,0x69,0x6e,0x63,0x72,0x65,0x6d,0x65,0x6e,0x74,0x61,
		0x6c,0x29,0x20,0x65,0x6e,0x63,0x6f,0x64,0x65,0x72,0x20,0x69,0x6e,0x70,0x75,0x74,
		0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x31,0x36,0x2d,0x62,0x69,
		0x74,0x2c,0x20,0x6d,0x6f,0x74,0x6f,0x72,0x20,0x63,0x6f,0x6e,0x74,0x72,0x6f,0x6c,
		0x20,0x50,0x57,0x4d,0x20,0x74,0x69,0x6d,0x65,0x72,0x20,0x77,0x69,0x74,0x68,0x20,
		0x64,0x65,0x61,0x64,0x74,0x69,0x6d,0x65,0x20,0x67,0x65,0x6e,0x65,0x72,0x61,0x74,
		0x69,0x6f,0x6e,0x20,0x61,0x6e,0x64,0x20,0x65,0x6d,0x65,0x72,0x67,0x65,0x6e,0x63,
		0x79,0x20,0x73,0x74,0x6f,0x70,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,
		0x3e,0x32,0x20,0x77,0x61,0x74,0x63,0x68,0x64,0x6f,0x67,0x20,0x74,0x69,0x6d,0x65,
		0x72,0x73,0x20,0x28,0x49,0x6e,0x64,0x65,0x70,0x65,0x6e,0x64,0x65,0x6e,0x74,0x20,
		0x61,0x6e,0x64,0x20,0x57,0x69,0x6e,0x64,0x6f,0x77,0x29,0x3c,0x2f,0x6c,0x69,0x3e,
		0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x53,0x79,0x73,0x54,0x69,0x63,0x6b,0x20,0x74,0x69,
		0x6d,0x65,0x72,0x20,0x32,0x34,0x2d,0x62,0x69,0x74,0x20,0x64,0x6f,0x77,0x6e,0x63,
		0x6f,0x75,0x6e,0x74,0x65,0x72,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,
		0x3e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x55,0x70,0x20,0x74,0x6f,0x20,0x39,
		0x20,0x63,0x6f,0x6d,0x6d,0x75,0x6e,0x69,0x63,0x61,0x74,0x69,0x6f,0x6e,0x20,0x69,
		0x6e,0x74,0x65,0x72,0x66,0x61,0x63,0x65,0x73,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x70,
		0x3e,0x3c,0x75,0x6c,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x55,0x70,0x20,0x74,0x6f,
		0x20,0x32,0x20,0x78,0x20,0x49,0x32,0x43,0x20,0x69,0x6e,0x74,0x65,0x72,0x66,0x61,
		0x63,0x65,0x73,0x20,0x28,0x53,0x4d,0x42,0x75,0x73,0x2f,0x50,0x4d,0x42,0x75,0x73,
		0x29,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x55,0x70,0x20,0x74,
		0x6f,0x20,0x33,0x20,0x55,0x53,0x41,0x52,0x54,0x73,0x20,0x28,0x49,0x53,0x4f,0x20,
		0x37,0x38,0x31,0x36,0x20,0x69,0x6e,0x74,0x65,0x72,0x66,0x61,0x63,0x65,0x2c,0x20,
		0x4c,0x49,0x4e,0x2c,0x20,0x49,0x72,0x44,0x41,0x20,0x63,0x61,0x70,0x61,0x62,0x69,
		0x6c,0x69,0x74,0x79,0x2c,0x20,0x6d,0x6f,0x64,0x65,0x6d,0x20,0x63,0x6f,0x6e,0x74,
		0x72,0x6f,0x6c,0x29,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x55,
		0x70,0x20,0x74,0x6f,0x20,0x32,0x20,0x53,0x50,0x49,0x73,0x20,0x28,0x31,0x38,0x20,
		0x4d,0x62,0x69,0x74,0x2f,0x73,0x29,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x09,0x3c,0x6c,
		0x69,0x3e,0x43,0x41,0x4e,0x20,0x69,0x6e,0x74,0x65,0x72,0x66,0x61,0x63,0x65,0x20,
		0x28,0x32,0x2e,0x30,0x42,0x20,0x41,0x63,0x74,0x69,0x76,0x65,0x29,0x3c,0x2f,0x6c,
		0x69,0x3e,0x0a,0x09,0x3c,0x6c,0x69,0x3e,0x55,0x53,0x42,0x20,0x32,0x2e,0x30,0x20,
		0x66,0x75,0x6c,0x6c,0x2d,0x73,0x70,0x65,0x65,0x64,0x20,0x69,0x6e,0x74,0x65,0x72,
		0x66,0x61,0x63,0x65,0x3c,0x2f,0x6c,0x69,0x3e,0x0a,0x3c,0x2f,0x75,0x6c,0x3e,0x3c,
		0x2f,0x70,0x3e,0x0a,0x3c,0x70,0x3e,0x43,0x52,0x43,0x20,0x63,0x61,0x6c,0x63,0x75,
		0x6c,0x61,0x74,0x69,0x6f,0x6e,0x20,0x75,0x6e,0x69,0x74,0x2c,0x20,0x39,0x36,0x2d,
		0x62,0x69,0x74,0x20,0x75,0x6e,0x69,0x71,0x75,0x65,0x20,0x49,0x44,0x3c,0x2f,0x70,
		0x3e,0x0a,0x3c,0x70,0x3e,0x50,0x61,0x63,0x6b,0x61,0x67,0x65,0x73,0x20,0x61,0x72,
		0x65,0x20,0x45,0x43,0x4f,0x50,0x41,0x43,0x4b,0xae,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,
		0x68,0x32,0x3e,0x31,0x2e,0x20,0x49,0x6e,0x74,0x72,0x6f,0x64,0x75,0x63,0x74,0x69,
		0x6f,0x6e,0x3c,0x2f,0x68,0x32,0x3e,0x0a,0x3c,0x70,0x3e,0x54,0x68,0x69,0x73,0x20,
		0x64,0x61,0x74,0x61,0x73,0x68,0x65,0x65,0x74,0x20,0x70,0x72,0x6f,0x76,0x69,0x64,
		0x65,0x73,0x20,0x74,0x68,0x65,0x20,0x6f,0x72,0x64,0x65,0x72,0x69,0x6e,0x67,0x20,
		0x69,0x6e,0x66,0x6f,0x72,0x6d,0x61,0x74,0x69,0x6f,0x6e,0x20,0x61,0x6e,0x64,0x20,
		0x6d,0x65,0x63,0x68,0x61,0x6e,0x69,0x63,0x61,0x6c,0x20,0x64,0x65,0x76,0x69,0x63,
		0x65,0x20,0x63,0x68,0x61,0x72,0x61,0x63,0x74,0x65,0x72,0x69,0x73,0x74,0x69,0x63,
		0x73,0x20,0x6f,0x66,0x20,0x74,0x68,0x65,0x20,0x53,0x54,0x4d,0x33,0x32,0x46,0x31,
		0x30,0x33,0x78,0x38,0x20,0x61,0x6e,0x64,0x20,0x53,0x54,0x4d,0x33,0x32,0x46,0x31,
		0x30,0x33,0x78,0x42,0x20,0x6d,0x65,0x64,0x69,0x75,0x6d,0x2d,0x64,0x65,0x6e,0x73,
		0x69,0x74,0x79,0x20,0x70,0x65,0x72,0x66,0x6f,0x72,0x6d,0x61,0x6e,0x63,0x65,0x20,
		0x6c,0x69,0x6e,0x65,0x20,0x6d,0x69,0x63,0x72,0x6f,0x63,0x6f,0x6e,0x74,0x72,0x6f,
		0x6c,0x6c,0x65,0x72,0x73,0x2e,0x3c,0x2f,0x70,0x3e,0x0a,0x3c,0x2f,0x62,0x6f,0x64,
		0x79,0x3e,0x3c,0x2f,0x68,0x74,0x6d,0x6c,0x3e};
//-----------------------------------------------
const __uint8 e404_htm[] = {
		0x3c,0x68,0x74,0x6d,0x6c,0x3e,0x0a,0x20,0x20,0x3c,0x68,0x65,0x61,0x64,0x3e,0x0a,
		0x20,0x20,0x20,0x20,0x3c,0x74,0x69,0x74,0x6c,0x65,0x3e,0x34,0x30,0x34,0x20,0x4e,
		0x6f,0x74,0x20,0x46,0x6f,0x75,0x6e,0x64,0x3c,0x2f,0x74,0x69,0x74,0x6c,0x65,0x3e,
		0x0a,0x20,0x20,0x3c,0x2f,0x68,0x65,0x61,0x64,0x3e,0x0a,0x3c,0x62,0x6f,0x64,0x79,
		0x3e,0x0a,0x3c,0x68,0x31,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x74,0x65,0x78,
		0x74,0x2d,0x61,0x6c,0x69,0x67,0x6e,0x3a,0x20,0x63,0x65,0x6e,0x74,0x65,0x72,0x3b,
		0x22,0x3e,0x34,0x30,0x34,0x20,0x45,0x72,0x72,0x6f,0x72,0x20,0x46,0x69,0x6c,0x65,
		0x20,0x4e,0x6f,0x74,0x20,0x46,0x6f,0x75,0x6e,0x64,0x3c,0x2f,0x68,0x31,0x3e,0x0a,
		0x3c,0x68,0x32,0x20,0x73,0x74,0x79,0x6c,0x65,0x3d,0x22,0x74,0x65,0x78,0x74,0x2d,
		0x61,0x6c,0x69,0x67,0x6e,0x3a,0x20,0x63,0x65,0x6e,0x74,0x65,0x72,0x3b,0x22,0x3e,
		0x20,0x54,0x68,0x65,0x20,0x70,0x61,0x67,0x65,0x20,0x79,0x6f,0x75,0x20,0x61,0x72,
		0x65,0x20,0x6c,0x6f,0x6f,0x6b,0x69,0x6e,0x67,0x20,0x66,0x6f,0x72,0x20,0x6d,0x69,
		0x67,0x68,0x74,0x20,0x68,0x61,0x76,0x65,0x20,0x62,0x65,0x65,0x6e,0x20,0x72,0x65,
		0x6d,0x6f,0x76,0x65,0x64,0x2c,0x20,0x3c,0x62,0x72,0x20,0x2f,0x3e,0x68,0x61,0x64,
		0x20,0x69,0x74,0x73,0x20,0x6e,0x61,0x6d,0x65,0x20,0x63,0x68,0x61,0x6e,0x67,0x65,
		0x64,0x2c,0x20,0x6f,0x72,0x20,0x69,0x73,0x20,0x74,0x65,0x6d,0x70,0x6f,0x72,0x61,
		0x72,0x69,0x6c,0x79,0x20,0x75,0x6e,0x61,0x76,0x61,0x69,0x6c,0x61,0x62,0x6c,0x65,
		0x2e,0x3c,0x2f,0x68,0x32,0x3e,0x0a,0x3c,0x2f,0x62,0x6f,0x64,0x79,0x3e,0x3c,0x2f,
		0x68,0x74,0x6d,0x6c,0x3e};
//-----------------------------------------------
//���������� ��������� TCP-������
void tcp_header_prepare(tcp_pkt_ptr *tcp_pkt, __uint16 port, __uint8 fl, __uint16 len, __uint16 len_cs)
{
	tcp_pkt->port_dst = be16toword(port);
	tcp_pkt->port_src = be16toword(LOCAL_PORT_TCP);
	tcp_pkt->bt_num_seg = tcpprop.seq_num;
	tcp_pkt->num_ask = tcpprop.ack_num;
	tcp_pkt->fl = fl;
	tcp_pkt->size_wnd = be16toword(tcp_size_wnd);
	tcp_pkt->urg_ptr = 0;
	tcp_pkt->len_hdr = len << 2;
	tcp_pkt->cs = 0;
	tcp_pkt->cs=checksum((__uint8*)tcp_pkt-8, len_cs+8, 2);
}
//--------------------------------------------------
//���������� ��������� IP-������
void ip_header_prepare(__S_Ip_Pkt *ip_pkt, __uint8 *ip_addr, __uint8 prt, __uint16 len)
{
	ip_pkt->len=be16toword(len);
	ip_pkt->id = 0;
	ip_pkt->ts = 0;
	ip_pkt->verlen = 0x45;
	ip_pkt->fl_frg_of=0;
	ip_pkt->ttl=128;
	ip_pkt->cs = 0;
	ip_pkt->prt=prt;
	memcpy(ip_pkt->ipaddr_dst,ip_addr,4);
	memcpy(ip_pkt->ipaddr_src,ipaddr,4);
	ip_pkt->cs = checksum((void*)ip_pkt,sizeof(__S_Ip_Pkt),0);
}
//--------------------------------------------------
/*�������� ������ �� ������ ����������*/
__uint8 tcp_send_synack(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);
	tcpprop.seq_num = rand();
	tcpprop.ack_num = be32todword(be32todword(tcp_pkt->bt_num_seg) + 1);
	tcp_pkt->data[0]=2;//Maximum Segment Size (2)
	tcp_pkt->data[1]=4;//Length
	tcp_pkt->data[2]=(__uint8) (tcp_mss>>8);//MSS = 458
	tcp_pkt->data[3]=(__uint8) tcp_mss;
	len = sizeof(tcp_pkt_ptr)+4;
	tcp_header_prepare(tcp_pkt, port, TCP_SYN|TCP_ACK, len, len);
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	//�������� ��������� Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);	
	tcp_stat = TCP_CONNECTED;
	return res;
}
//--------------------------------------------------
/*�������� ������ �� ������ ������������ � ����� �������� ������ �� ������� ��� �������*/
__uint8 tcp_send_finack(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);
	tcpprop.seq_num = tcp_pkt->num_ask;
	tcpprop.ack_num = be32todword(be32todword(tcp_pkt->bt_num_seg) + 1);
	len = sizeof(tcp_pkt_ptr);
	tcp_header_prepare(tcp_pkt, port, TCP_ACK, len, len);
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	//�������� ��������� Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);
	if(tcp_stat == TCP_DISCONNECTED) return 0;
	tcp_pkt->fl = TCP_FIN|TCP_ACK;
	len = sizeof(tcp_pkt_ptr);
	tcp_pkt->cs = 0;
	tcp_pkt->cs=checksum((__uint8*)tcp_pkt-8, len+8, 2);
	len+=sizeof(__S_Ip_Pkt);
	eth_send(frame,ETH_IP,len);
	tcp_stat = TCP_DISCONNECTED;	
	return res;
}
//--------------------------------------------------
/*������������� �� ����� ������ � ����� ��� �������*/
__uint8 tcp_send_data(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len=0;
	__uint16 sz_data=0;
	tcp_stat = TCP_CONNECTED;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);
	sz_data = be16toword(ip_pkt->len)-20-(tcp_pkt->len_hdr>>2);
	tcpprop.seq_num = tcp_pkt->num_ask;
	tcpprop.ack_num = be32todword(be32todword(tcp_pkt->bt_num_seg) + sz_data);
	len = sizeof(tcp_pkt_ptr);
	//�������� ������������� �� ����� ������
	tcp_header_prepare(tcp_pkt, port, TCP_ACK, len, len);
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	//�������� ��������� Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);
	//���� ������ "Hello!!!", �� �������� �����
	if (!strcmp((char*)tcp_pkt->data,"Hello!!!"))
	{
		strcpy((char*)tcp_pkt->data,"Hello to TCP Client!!!\r\n");
		tcp_pkt->fl = TCP_ACK|TCP_PSH;
		len = sizeof(tcp_pkt_ptr);
		len+=strlen((char*)tcp_pkt->data);
		tcp_pkt->cs = 0;
		tcp_pkt->cs=checksum((__uint8*)tcp_pkt-8, len+8, 2);
		len+=sizeof(__S_Ip_Pkt);
		ip_pkt->len=be16toword(len);
		ip_pkt->cs = 0;
		ip_pkt->cs = checksum((void*)ip_pkt,sizeof(__S_Ip_Pkt),0);
		//�������� ��������� Ethernet
		eth_send(frame,ETH_IP,len);
	}
	return res;
}
//--------------------------------------------------

__uint8 tcp_send_http_one(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__ENTER__

	__uint8 res=0;
	__uint16 len=0;
	__uint16 sz_data=0;

	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);

	sz_data = be16toword(ip_pkt->len)-20-(tcp_pkt->len_hdr>>2);

	tcpprop.seq_num = tcp_pkt->num_ask;
	tcpprop.ack_num = be32todword(be32todword(tcp_pkt->bt_num_seg) + sz_data);

	len = sizeof(tcp_pkt_ptr);

	tcp_header_prepare(tcp_pkt, port, TCP_ACK, len, len);

	len+=sizeof(__S_Ip_Pkt);

	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	//get add dest from packet Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);

	if ((tcpprop.http_doc==EXISTING_HTML)||(tcpprop.http_doc==EXISTING_JPG))
	{
		// mount sdcard
		result = f_mount(&SDFatFs, (TCHAR const*)USERPath, 0);
		console_serial_print_log("\t> f_mount: %d",result);

		result=f_open(&MyFile,tcpprop.fname,FA_READ);
		console_serial_print_log("\t> f_open: %d  f_size: %lu",result, MyFile.obj.objsize);

		result=f_lseek(&MyFile,0);
		console_serial_print_log("\t>f_lseek: %d\r\n",result);

		if (tcpprop.http_doc==EXISTING_HTML)
		{
			strcpy((char*)tcp_pkt->data, http_header);
			result = f_read(&MyFile, (void*)(tcp_pkt->data+strlen(http_header)), \
					(__uint16)MyFile.obj.objsize, (UINT *)&bytesread);
		}
		else
		{
			strcpy((char*)tcp_pkt->data,jpg_header);
			result = f_read(&MyFile,(void*)(tcp_pkt->data+strlen(jpg_header)),\
					(__uint16)MyFile.obj.objsize, (UINT *)&bytesread);
		}
	}
	else
	{
		strcpy((char*)tcp_pkt->data,error_header);
		memcpy((void*)(tcp_pkt->data+strlen(error_header)),(void*)e404_htm,sizeof(e404_htm));
	}

	len = sizeof(tcp_pkt_ptr);
	len+=tcpprop.data_size;

	tcp_pkt->fl 	= TCP_PSH|TCP_ACK;
	tcp_pkt->cs 	= 0;
	tcp_pkt->cs		= checksum((__uint8*)tcp_pkt-8, len+8, 2);

	len+=sizeof(__S_Ip_Pkt);

	ip_pkt->len		= be16toword(len);
	ip_pkt->cs 		= 0;
	ip_pkt->cs 		= checksum((void*)ip_pkt,sizeof(__S_Ip_Pkt),0);
	//send packet Ethernet
	eth_send(frame,ETH_IP,len);

	tcpprop.seq_num_tmp = be32todword(be32todword(tcpprop.seq_num)+tcpprop.data_size);
	tcpprop.data_stat=DATA_END;

	__LEAVE__

	return res;

}
//--------------------------------------------------
// send sub packet fist of HTTP packet
__uint8 tcp_send_http_first(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len=0;
	__uint16 sz_data=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);

	sz_data = be16toword(ip_pkt->len)-20-(tcp_pkt->len_hdr>>2);
	tcpprop.seq_num = tcp_pkt->num_ask;
	tcpprop.ack_num = be32todword(be32todword(tcp_pkt->bt_num_seg) + sz_data);

	len = sizeof(tcp_pkt_ptr);
	tcp_header_prepare(tcp_pkt, port, TCP_ACK, len, len);

	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);

	//get address Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);


	if ((tcpprop.http_doc == EXISTING_HTML)||(tcpprop.http_doc == EXISTING_JPG))
	{
		strcpy((char*)tcp_pkt->data, http_header);

		result=f_mount(&SDFatFs,(TCHAR const*)USERPath,0);
		result=f_open(&MyFile,tcpprop.fname,FA_READ);
		result=f_lseek(&MyFile,0);

		if (tcpprop.http_doc == EXISTING_HTML)
		{
			strcpy((char*)tcp_pkt->data,http_header);
			result=f_read(&MyFile,(void*)(tcp_pkt->data+strlen(http_header)),tcp_mss-strlen(http_header),(UINT *)&bytesread);
		}
		else
		{
			strcpy((char*)tcp_pkt->data,jpg_header);
			result=f_read(&MyFile,(void*)(tcp_pkt->data+strlen(jpg_header)),tcp_mss-strlen(jpg_header),(UINT *)&bytesread);
		}
	}
	else
	{
		strcpy((char*)tcp_pkt->data,error_header);
		memcpy((void*)(tcp_pkt->data+strlen(error_header)),(void*)e404_htm,tcp_mss-strlen(error_header));
	}
	tcp_pkt->fl = TCP_ACK;
	len = sizeof(tcp_pkt_ptr);
	len+=tcp_mss;
	tcp_pkt->cs = 0;
	tcp_pkt->cs=checksum((__uint8*)tcp_pkt-8, len+8, 2);
	len+=sizeof(__S_Ip_Pkt);
	ip_pkt->len=be16toword(len);
	ip_pkt->cs = 0;
	ip_pkt->cs = checksum((void*)ip_pkt,sizeof(__S_Ip_Pkt),0);
	//�������� ��������� Ethernet
	eth_send(frame,ETH_IP,len);

	tcpprop.cnt_rem_data_part--;

	//check status next packet
	tcpprop.cnt_size_wnd += tcp_mss;

	if(tcpprop.cnt_rem_data_part>1)
	{
		tcpprop.data_stat=DATA_MIDDLE;
	}
	else
	{
		tcpprop.data_stat=DATA_LAST;
	}
	return res;
}
//--------------------------------------------------
__uint8 tcp_send_http_middle(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len_tcp=0, len=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);

	tcpprop.seq_num = be32todword(be32todword(tcpprop.seq_num)+tcp_mss);
	len_tcp = sizeof(tcp_pkt_ptr);

	if ((tcpprop.http_doc==EXISTING_HTML)||(tcpprop.http_doc==EXISTING_JPG))
	{
		if (tcpprop.http_doc==EXISTING_HTML)
		{
			result=f_lseek(&MyFile,((uint32_t)tcp_mss*(tcpprop.cnt_data_part-tcpprop.cnt_rem_data_part))-strlen(http_header)); //��������� ������ ������ � �����
		}
		else
		{
			result=f_lseek(&MyFile,((uint32_t)tcp_mss*(tcpprop.cnt_data_part-tcpprop.cnt_rem_data_part))-strlen(jpg_header)); //��������� ������ ������ � �����
		}
		result=f_read(&MyFile,(void*)tcp_pkt->data,tcp_mss,(UINT *)&bytesread);
	}
	else
	{
		memcpy((void*)tcp_pkt->data,(void*)(e404_htm+(tcp_mss*(tcpprop.cnt_data_part-tcpprop.cnt_rem_data_part))-strlen(error_header)),tcp_mss);
	}
	len=len_tcp + tcp_mss;

	if ((tcp_size_wnd - tcpprop.cnt_size_wnd) > tcp_mss)
	{
		tcp_header_prepare(tcp_pkt, port, TCP_ACK, len_tcp, len);
	}
	else
	{
		tcp_header_prepare(tcp_pkt, port, TCP_PSH|TCP_ACK, len_tcp, len);

		tcpprop.cnt_size_wnd = 0;
	}
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);

	memcpy(frame->addr_dest,tcpprop.macaddr_dst,6);
	eth_send(frame,ETH_IP,len);

	tcpprop.cnt_rem_data_part--;

	tcpprop.cnt_size_wnd += tcp_mss;
	if(tcpprop.cnt_rem_data_part>1)
	{
		tcpprop.data_stat=DATA_MIDDLE;
	}
	else
	{
		tcpprop.data_stat=DATA_LAST;
	}
	return res;
}
//--------------------------------------------------

__uint8 tcp_send_http_last(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len_tcp=0, len=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);

	tcpprop.seq_num = be32todword(be32todword(tcpprop.seq_num)+tcp_mss);
	len_tcp = sizeof(tcp_pkt_ptr);
	if ((tcpprop.http_doc==EXISTING_HTML)||(tcpprop.http_doc==EXISTING_JPG))
	{
		if (tcpprop.http_doc==EXISTING_HTML)
		{
			result=f_lseek(&MyFile,(tcp_mss*(tcpprop.cnt_data_part-1))-strlen(http_header));
		}
		else
		{
			result=f_lseek(&MyFile,(tcp_mss*(tcpprop.cnt_data_part-1))-strlen(jpg_header));
		}
		console_serial_print_log("f_lseek: %d\r\n",result);

		result=f_read(&MyFile,(void*)tcp_pkt->data,tcpprop.last_data_part_size,(UINT *)&bytesread);
	}
	else
	{
		memcpy((void*)tcp_pkt->data,(void*)(e404_htm+(tcp_mss*(tcpprop.cnt_data_part-1))-strlen(error_header)),tcpprop.last_data_part_size);
	}
	len=len_tcp + tcpprop.last_data_part_size;
	tcp_header_prepare(tcp_pkt, port, TCP_PSH|TCP_ACK, len_tcp, len);
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	// Ethernet
	memcpy(frame->addr_dest,tcpprop.macaddr_dst,6);
	eth_send(frame,ETH_IP,len);	
	//
	tcpprop.seq_num_tmp = be32todword(be32todword(tcp_pkt->bt_num_seg)+tcpprop.last_data_part_size);
	tcpprop.data_stat=DATA_END;
	return res;
}
//--------------------------------------------------

__uint8 tcp_send_http_dataend(__S_Enc28j60_Frame_Pkt *frame, __uint8 *ip_addr, __uint16 port)
{
	__uint8 res=0;
	__uint16 len=0;
	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);
	tcpprop.seq_num = tcpprop.seq_num_tmp;
	tcpprop.ack_num = tcp_pkt->bt_num_seg;
	len = sizeof(tcp_pkt_ptr);
	tcp_header_prepare(tcp_pkt, port, TCP_FIN|TCP_ACK, len, len);
	len+=sizeof(__S_Ip_Pkt);
	ip_header_prepare(ip_pkt, ip_addr, IP_TCP, len);
	//�������� ��������� Ethernet
	memcpy(frame->addr_dest,frame->addr_src,6);
	eth_send(frame,ETH_IP,len);
	tcpprop.data_stat=DATA_COMPLETED;
	tcp_stat = TCP_DISCONNECTED;
	return res;
}

//--------------------------------------------------
__uint8 tcp_read(__S_Enc28j60_Frame_Pkt *frame, __uint16 len)
{
	__uint8 res = 0;
	__uint16 len_data = 0;
	__uint16 i = 0
			;
	char *ss1;
	int ch1=' ';
	int ch2='.';

	__S_Ip_Pkt *ip_pkt = (void*)(frame->data);
	tcp_pkt_ptr *tcp_pkt = (void*)(ip_pkt->data);

	memcpy(tcpprop.macaddr_dst,frame->addr_src,6);
	memcpy(tcpprop.ipaddr_dst,ip_pkt->ipaddr_src,4);

	tcpprop.port_dst = be16toword(tcp_pkt->port_src);

	len_data = be16toword(ip_pkt->len)-20-(tcp_pkt->len_hdr>>2);

	console_serial_print_log("\t> Packet : %d.%d.%d.%d-%d.%d.%d.%d %d tcp",
			ip_pkt->ipaddr_src[0],ip_pkt->ipaddr_src[1],ip_pkt->ipaddr_src[2],ip_pkt->ipaddr_src[3],
			ip_pkt->ipaddr_dst[0],ip_pkt->ipaddr_dst[1],ip_pkt->ipaddr_dst[2],ip_pkt->ipaddr_dst[3], len_data);

	if (len_data)
	{
		// view comtent packet
		console_serial_print_infor("TCP packet content :\n%s", tcp_pkt->data);

		// packet ip is ACK
		if (tcp_pkt->fl & TCP_ACK)
		{
			// console_serial_print_log
			// packet "GET /", for protocol HTTP
			if (strncmp((char*)tcp_pkt->data, "GET /", 5) == 0)
			{
				tcpprop.cnt_size_wnd = 0;


				if((char)tcp_pkt->data[5]==' ')
				{
					// HTTP/GET no  target file
					console_serial_print_log("\t> HTTP/GET no  target file");

					strcpy(tcpprop.fname,"index.html");
					tcpprop.http_doc = EXISTING_HTML;
				}
				else
				{
					// HTTP/GET contain target file
					console_serial_print_log("\t> HTTP/GET contain target file");

					memcpy((void*)tcpprop.fname, (void*)(tcp_pkt->data + 5), 20);
					ss1 = strchr(tcpprop.fname, ch1);
					ss1[0] = 0;
				}

				console_serial_print_log("\t>%s : %d", (__uint8*)tcpprop.fname, strlen(tcpprop.fname));

				// open sd card and prepare file for send
				result = f_mount(&SDFatFs,(TCHAR const*)USERPath,0);
				console_serial_print_log("f_mount: %d",result);

				result = f_open(&MyFile,tcpprop.fname,FA_READ);

				console_serial_print_log("f_open: %d  f_size: %lu",result, MyFile.obj.objsize);

				if (result == FR_OK)
				{
					ss1 = strchr(tcpprop.fname,ch2);
					ss1++;

					if (strncmp(ss1,"jpg", 3) == 0)
					{
						tcpprop.http_doc = EXISTING_JPG;

						tcpprop.data_size = strlen(jpg_header);
					}
					else
					{
						tcpprop.http_doc = EXISTING_HTML;

						tcpprop.data_size = strlen(http_header);
					}

					tcpprop.data_size += MyFile.obj.objsize;
				}
				else
				{
					tcpprop.http_doc = E404_HTML;

					tcpprop.data_size = strlen(error_header);

					tcpprop.data_size += sizeof(e404_htm);
				}

				tcpprop.cnt_rem_data_part = tcpprop.data_size / tcp_mss + 1;
				tcpprop.last_data_part_size = tcpprop.data_size % tcp_mss;

				if(tcpprop.last_data_part_size == 0)
				{
					tcpprop.last_data_part_size = tcp_mss;
					tcpprop.cnt_rem_data_part--;
				}

				tcpprop.cnt_data_part = tcpprop.cnt_rem_data_part;

				console_serial_print_log("data size:%lu; cnt data part:%u; last_data_part_size:%u; port dst:%u",
						(unsigned long)tcpprop.data_size, tcpprop.cnt_rem_data_part, tcpprop.last_data_part_size,tcpprop.port_dst);

				if (tcpprop.cnt_rem_data_part == 1)
				{
					tcpprop.data_stat = DATA_ONE;
				}
				else if (tcpprop.cnt_rem_data_part > 1)
				{
					tcpprop.data_stat = DATA_FIRST;
				}

				if(tcpprop.data_stat == DATA_ONE)
				{
					tcp_send_http_one(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
				}
				else if(tcpprop.data_stat == DATA_FIRST)
				{
					console_serial_print_log("-------------START-----------");
					tcp_send_http_first(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
				}
			}
			else
			{
				tcp_send_data(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
			}
		}
	}


	if (tcp_pkt->fl == TCP_SYN)
	{
		tcp_send_synack(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
	}
	else if (tcp_pkt->fl == (TCP_FIN|TCP_ACK))
	{
		tcp_send_finack(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
	}
	else if (tcp_pkt->fl == (TCP_PSH|TCP_ACK))
	{
		if(!len_data)
		{
			tcp_send_finack(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
		}
	}
	else if (tcp_pkt->fl == TCP_ACK)
	{
		if (tcpprop.data_stat == DATA_END)
		{
			tcp_send_http_dataend(frame, ip_pkt->ipaddr_src, tcpprop.port_dst);
		}
		else if (tcpprop.data_stat == DATA_MIDDLE)
		{
			tcp_send_http_middle(frame, tcpprop.ipaddr_dst, tcpprop.port_dst);
		}
		else if (tcpprop.data_stat == DATA_LAST)
		{
			console_serial_print_log("-------------LAST-----------");
			tcpprop.data_stat = DATA_COMPLETED;
			tcp_send_http_last(frame, tcpprop.ipaddr_dst, tcpprop.port_dst);
		}
	}

	return res;
}
//--------------------------------------------------
